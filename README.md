# SmoQyDQMC

[![Stable](https://img.shields.io/badge/docs-stable-blue.svg)](https://SmoQySuite.github.io/SmoQyDQMC.jl/stable/)
[![Dev](https://img.shields.io/badge/docs-dev-blue.svg)](https://SmoQySuite.github.io/SmoQyDQMC.jl/dev/)
[![Build Status](https://github.com/SmoQySuite/SmoQyDQMC.jl/actions/workflows/CI.yml/badge.svg?branch=main)](https://github.com/SmoQySuite/SmoQyDQMC.jl/actions/workflows/CI.yml?query=branch%3Amain)
[![Coverage](https://codecov.io/gh/SmoQySuite/SmoQyDQMC.jl/branch/main/graph/badge.svg)](https://codecov.io/gh/SmoQySuite/SmoQyDQMC.jl)
![](https://img.shields.io/badge/Lifecycle-Maturing-007EC6g)

This package implements the determinant quantum Monte Carlo (DQMC) method for Hubbard,
and electron-phonon interactions, including both Holstein and Su-Schrieffer-Heeger (SSH) style
electron-phonon coupling.

## Diff From Main Repository

### Intro

This fork aims to tackle the sometimes large amounts of file I/O generated by this package. Our research group was unfortunately crashing our HPC due to large numbers of files, so this is our solution. We take advantage of Julia's multiple dispatch so that code written for the original version of SmoQyDQMC will run as normal. Setting `LessIO = false` will also restore original functionality.

### Example file trees

Some comparisons of output directions for our research group's use case. We only need global stats, local stats, and spin-z correlations for our work, with no need for saving the bin files. For each run we only need to create one directory and save 4 .CSV files to it, whereas for standard operation we would need to create many folders and bin files which then take extra time to clean up at the end.

#### Standard Outputs (before deleting bins)

```
/hubbard_square_U$U_mu$mu_L$L_b$beta-$sID/
├── equal-time/
|    └── spin-z
|        ├── momentum/
|        |    └── bin files
|        ├── position/
|        |    └── bin files
│        ├── spin_z_momentum_equal-time_stats.csv
│        └── spin_z_position_equal-time_stats.csv
├── global/
|    └── bin files
├── integrated/
|    └── (empty folder)
├── local/
|    └── bin files
├── time-displaced/
|    └── (empty folder)
├── global_stats.csv
├── local_stats.csv
└── model_summary.toml

total: 4*N_bins bin files + 4 .csv files + 1 .toml file. 8 folders.
```

#### Standard Outputs (after running delete_jld2_bins())

```
/hubbard_square_U$U_mu$mu_L$L_b$beta-$sID/
├── equal-time/
|    └── spin-z
|        ├── momentum/
|        |    └── (empty folder)
|        ├── position/
|        |    └── (empty folder)
│        ├── spin_z_momentum_equal-time_stats.csv
│        └── spin_z_position_equal-time_stats.csv
├── global/
|    └── (empty folder)
├── integrated/
|    └── (empty folder)
├── local/
|    └── (empty folder)
├── time-displaced/
|    └── (empty folder)
├── global_stats.csv
├── local_stats.csv
└── model_summary.toml

total: 4 .csv files + 1 .toml file. 8 folders.
```

#### With LessIO

```
/hubbard_square_U$U_mu$mu_L$L_b$beta-$sID/
├── global_stats.csv
├── local_stats.csv
├── spin_z_momentum_equal-time_stats.csv
└── spin_z_position_equal-time_stats.csv

total: 4 .csv files
```

### Performance Improvements

After running a number of benchmarks using [BenchmarkTools.jl](https://github.com/JuliaCI/BenchmarkTools.jl), we saw an average speedup of 52% for LessIO compared to standard runs with no cleanup at the end. If we want to delete the bin files at the end, which takes extra time, LessIO provides an average of a 76.7% speedup. Note that these were tested on small system sizes, square lattice $L=2,4,6; \beta=1.0,2.0,3.0,4.0,5.0;U=0.0,2.0$, with 2000 warmup sweeps, 2000 measurement sweeps, and 20 bins. These speedups may improve or worsen for larger system sizes or runs with more bins or sweeps.

### Modifying Your Existing SmoQyDQMC Code for LessIO

Modifying your existing code to work with LessIO is pretty straightforward and easy!

- Create an array ahead of time to store different versions of `measurement_container`. We will then generate averages and outputs based on these instead of the bin files.

  -     measurement_array = Vector{NamedTuple}(undef, N_bins)

- Create a bool variable `LessIO` which we will pass to a few functions to enable/disable LessIO functionality

  -     LessIO = true

- Create only necessary subdirectories using a modified `initialize_measurement_directories()`. **Note this is only necessary if you are using time-displaced correlation functions, as that is not supported for LessIO at this time. If you are only examining equal-time and/or integrated correlation functions, then you don't have to call this function at all!**

  -     initialize_measurement_directories(LessIO; 
            simulation_info = simulation_info, 
            measurement_container = measurement_container)

- Suppress creation of `model_summary.toml` by adding an `if !LessIO` statement around it. Normally some functions will load parameters from this file, but with LessIO we store them in memory and pass them to those functions as arguments.

  -     if !LessIO
            model_summary(
            simulation_info = simulation_info,
            β = β, Δτ = Δτ,
            model_geometry = model_geometry,
            tight_binding_model = tight_binding_model,
            interactions = (hubbard_model,)
            )
        end

- Write the results of each bin to `measurement_array` instead of to bin files using a modified `write_measurements!()`. Here we add the argument `LessIO` and the keyword argument `measurement_array`.

  -     write_measurements!(LessIO;
            measurement_container = measurement_container,
            measurement_array = measurement_array,
            simulation_info = simulation_info,
            model_geometry = model_geometry,
            bin = bin,
            bin_size = bin_size,
            Δτ = Δτ
            )

- Generate output files `global_stats.csv`, `local_stats.csv`, and any others that are called for. This modified function places all of them in `simulation_info.datafolder` rather than in subdirectories.

  -     process_measurements(LessIO, 
            simulation_info.datafolder, 
            N_bins, 
            β, 
            Lτ, 
            model_geometry, 
            measurement_array
            )

### Current Limitations/Caveats

- Time-displaced and composite correlation functions are not currently supported for LessIO.
  - If using time-displaced correlation functions AND LessIO, equal-time and integrated correlation functions will be calcuated in regular LessIO fashion, and time-displaced correlation functions will be calculated the original way (with subdirectories and bin files).
  - If using time-displaced correlation functions AND LessIO, `delete_jld2_bins()` will probably not work. Not tested yet.

- MPI is not supported for LessIO.

### Installing this Fork

Installing this fork should be as simple as running the following:

    using Pkg
    Pkg.add(url="https://github.com/swestastic/SmoQyDQMC.jl")`

Just note that you may have to uninstall the original version first!

## Funding

The development of this code was supported by the U.S. Department of Energy, Office of Science, Basic Energy Sciences,
under Award Number DE-SC0022311.

## Installation

To install the [SmoQyDQMC.jl](https://github.com/SmoQySuite/SmoQyDQMC.jl),
simply open the Julia REPL and run the command

```julia
julia> ]
pkg> add SmoQyDQMC
```

or equivalently via `Pkg` do

```julia
julia> using Pkg; Pkg.add("SmoQyDQMC")
```

## Documentation

- [`STABLE`](https://SmoQySuite.github.io/SmoQyDQMC.jl/stable/): Documentation for the latest version of the code published to the Julia [General](https://github.com/JuliaRegistries/General.git) registry.
- [`DEV`](https://SmoQySuite.github.io/SmoQyDQMC.jl/dev/): Documentation associated with most recent commit to the main branch.

## Publication List

Follow this [link](https://smoqysuite.github.io/SmoQyDQMC.jl/dev/#Publication-List)
to see a list of some of the publications that report results generated using
the [SmoQyDQMC.jl](https://github.com/SmoQySuite/SmoQyDQMC.jl) package.

## Notable Package Dependencies

This section reviews some notable package dependencies.

### Re-exported Packages

The [SmoQyDQMC.jl](https://github.com/SmoQySuite/SmoQyDQMC.jl) re-exports certain packages using
the [Reexport.jl](https://github.com/simonster/Reexport.jl.git) package in order to simplify the installation process.

- [LatticeUtilties.jl](https://github.com/SmoQySuite/LatticeUtilities.jl.git): Used to represent arbitrary lattice geometries.
- [JDQMCFramework.jl](https://github.com/SmoQySuite/JDQMCFramework.jl.git): Implements and exports the basic framework for running a DQMC simulation.
- [JDQMCMeasurements.jl](https://github.com/SmoQySuite/JDQMCMeasurements.jl.git): Implements various global, local and correlation measurements for a DQMC simulation.
- [MuTuner.jl](https://github.com/cohensbw/MuTuner.jl.git): Impelments and exports an algorithm for tuning the chemical potential to achieve a target density in grand canonical Monte Carlo simulations.

### External Dependencies

- [StableLinearAlgebra.jl](https://github.com/SmoQySuite/StableLinearAlgebra.jl.git): Implements optimized numerical stabilizaiton methods required by DQMC simulations.
- [Checkerboard.jl](https://github.com/SmoQySuite/Checkerboard.jl.git): Implements and exports the checkerboard method for approximating exponentiated hopping matrices by a sparse matrix.
- [JLD2.jl](https://github.com/JuliaIO/JLD2.jl.git): Package used to write data to binary files in an HDF5 compatible format. It is also recommended this package be used at the scripting level to implement checkpointing in a simulation.

## Citation

If you found this library to be useful in the course of academic work, please consider citing us:

```bibtex
@Article{SmoQyDQMC.jl,
 title={{SmoQyDQMC.jl: A flexible implementation of determinant quantum Monte Carlo for Hubbard and electron-phonon interactions}},
 author={Benjamin Cohen-Stead and Sohan Malkaruge Costa and James Neuhaus and Andy Tanjaroon Ly and Yutan Zhang and Richard Scalettar and Kipton Barros and Steven Johnston},
 journal={SciPost Phys. Codebases},
 pages={29},
 year={2024},
 publisher={SciPost},
 doi={10.21468/SciPostPhysCodeb.29},
 url={https://scipost.org/10.21468/SciPostPhysCodeb.29},
 title={{SmoQyDQMC.jl: A flexible implementation of determinant quantum Monte Carlo for Hubbard and electron-phonon interactions}},
 author={Benjamin Cohen-Stead and Sohan Malkaruge Costa and James Neuhaus and Andy Tanjaroon Ly and Yutan Zhang and Richard Scalettar and Kipton Barros and Steven Johnston},
 journal={SciPost Phys. Codebases},
 pages={29},
 year={2024},
 publisher={SciPost},
 doi={10.21468/SciPostPhysCodeb.29},
 url={https://scipost.org/10.21468/SciPostPhysCodeb.29},
}
```

## Publications

A list of some of the publications that report results generated using [SmoQyDQMC.jl](https://github.com/SmoQySuite/SmoQyDQMC.jl)
can be found [here](https://smoqysuite.github.io/SmoQyDQMC.jl/stable/#Publication-List).

## Contact Us

For question and comments regarding this package, please email either Dr. Benjamin Cohen-Stead at [bcohenst@utk.edu](mailto:bcohenst@utk.edu) or Professor Steven Johnston at [sjohn145@utk.edu](mailto:sjohn145@utk.edu).
